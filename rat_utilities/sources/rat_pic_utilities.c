// ----------------------------------------------------------------------------------------------------
// Except when otherwise noted, this file is licensed under
// Creative Commons Attributions ShakeAlike 4.0 License (CC-BY-SA 4.0)
//
// https://creativecommons.org/licenses/by-sa/4.0/legalcode
//
// Copyright (c) 2020 - 2024 Rapiot Open Hardware Project
// ----------------------------------------------------------------------------------------------------

// ----------------------------------------------------------------------------------------------------
// Microchip PIC18LF25K22 Source File
// ----------------------------------------------------------------------------------------------------

// ----------------------------------------------------------------------------------------------------
// Includes
// ----------------------------------------------------------------------------------------------------
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>

// ----------------------------------------------------------------------------------------------------
// Defines
// ----------------------------------------------------------------------------------------------------

// ----------------------------------------------------------------------------------------------------
// Peripherals
// ----------------------------------------------------------------------------------------------------
#define UART_ENABLED 1
#define I2C_ENABLED  1
#define SPI_ENABLED  0

#define UART_BAUD_RATE 9600

// ----------------------------------------------------------------------------------------------------
// Init the pins
// ----------------------------------------------------------------------------------------------------
static void rat_init_pins (void)
{
  // --------------------------------------------------------------------------------------------------
  // By Default, all ports are digital outputs which are tied to low
  // --------------------------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------------------------
  // ANSEL
  // --------------------------------------------------------------------------------------------------
  ANSELA = 0x00;
  ANSELB = 0x00;
  ANSELC = 0x00;

  // --------------------------------------------------------------------------------------------------
  // TRIS
  // --------------------------------------------------------------------------------------------------
  TRISA  = 0x00;
  TRISB  = 0x00;

  TRISC.B0  = 0b0;
  TRISC.B1  = 0b0;
  TRISC.B2  = 0b0;
  TRISC.B3  = 0b0;
  TRISC.B4  = 0b0;
  TRISC.B5  = 0b0;

  if (!UART_ENABLED) {
    TRISC.B6  = 0b0;
    TRISC.B7  = 0b0;
  }

  // --------------------------------------------------------------------------------------------------
  // LAT
  // --------------------------------------------------------------------------------------------------
  LATA = 0x00;
  LATB = 0x00;
  LATC = 0x00;
}

// ----------------------------------------------------------------------------------------------------
// Init the clocks
// ----------------------------------------------------------------------------------------------------
static void rat_init_clocks (void)
{
  // --------------------------------------------------------------------------------------------------
  // Internal oscillator settings
  //
  // Oscillator source :
  //
  //  - Register : OSCCON
  //  - Field    : SCS [1:0]
  //  - Values   : "1X" - Internal oscillator block
  //               "01" - Secondary oscillator (SOSC)
  //               "00" - The primary clock is determined by FOSC[3:0] at CONFIG1H
  //
  // Internal oscillator frequency selection :
  //
  //  - Register : OSCCON
  //  - Field    : IRCF [2:0]
  //  - Values   : "111" - 16 MHz
  //               "110" -  8 MHz
  //               "101" -  4 MHz
  //               "100" -  2 MHz
  //               "011" -  1 MHz
  // --------------------------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------------------------
  // Clock source
  // --------------------------------------------------------------------------------------------------
  OSCCON.SCS1 = 0b0;
  OSCCON.SCS0 = 0b0;

  // --------------------------------------------------------------------------------------------------
  // Clock frequency : 8 MHz
  // --------------------------------------------------------------------------------------------------
  OSCCON.IRCF2 = 0b1;
  OSCCON.IRCF1 = 0b1;
  OSCCON.IRCF0 = 0b0;
}

// ----------------------------------------------------------------------------------------------------
// Init the I2C
// ----------------------------------------------------------------------------------------------------
static void rat_init_i2c (void)
{
  // --------------------------------------------------------------------------------------------------
  // I2C
  //
  // Note! There is no need to setup the ports manually!
  // --------------------------------------------------------------------------------------------------
  if (I2C_ENABLED) {
    // ------------------------------------------------------------------------------------------------
    // Init
    // ------------------------------------------------------------------------------------------------
    I2C1_Init(100000);
  }
}

// ----------------------------------------------------------------------------------------------------
// Init the SPI
// ----------------------------------------------------------------------------------------------------
static void rat_init_spi (void)
{
  // --------------------------------------------------------------------------------------------------
  // SPI
  // --------------------------------------------------------------------------------------------------
  if (SPI_ENABLED) {
    // ------------------------------------------------------------------------------------------------
    // Set signal types
    // ------------------------------------------------------------------------------------------------
    ANSELC.B3 = 0b0;
    ANSELC.B4 = 0b0;
    ANSELC.B5 = 0b0;

    // ------------------------------------------------------------------------------------------------
    // Set signal directions
    // ------------------------------------------------------------------------------------------------
    TRISC.B3 = 0b0;
    TRISC.B4 = 0b1;
    TRISC.B5 = 0b0;

    // ------------------------------------------------------------------------------------------------
    // Init
    // ------------------------------------------------------------------------------------------------
    SPI1_Init();
  }
}

// ----------------------------------------------------------------------------------------------------
// Init the UART
// ----------------------------------------------------------------------------------------------------
static void rat_init_uart (void)
{
  // --------------------------------------------------------------------------------------------------
  // UART
  // --------------------------------------------------------------------------------------------------
  if (UART_ENABLED) {
    // ------------------------------------------------------------------------------------------------
    // Set signal types
    // ------------------------------------------------------------------------------------------------
    ANSELC.B6 = 0b0;              // TX 1
    ANSELC.B7 = 0b0;              // RX 1

    // ------------------------------------------------------------------------------------------------
    // Set signal directions
    // ------------------------------------------------------------------------------------------------
    TRISC.B6  = 0b0;              // TX 1
    TRISC.B7  = 0b1;              // RX 1

    // ------------------------------------------------------------------------------------------------
    // Set the baud rate
    // ------------------------------------------------------------------------------------------------
    UART1_Init(UART_BAUD_RATE);   // UART baud rate
  }
}

// ----------------------------------------------------------------------------------------------------
// Init timers
// ----------------------------------------------------------------------------------------------------
void rat_init_timers (void)
{
  // --------------------------------------------------------------------------------------------------
  // Timer 1
  // --------------------------------------------------------------------------------------------------

  // Set the clock source to secondary oscillator
  T1CON.TMR1CS1 = 0b1;
  T1CON.TMR1CS0 = 0b0;

  // Enable the secondary oscillator
  T1CON.T1SOSCEN = 0b1;

  // Set the prescaler to two (four seconds)
  T1CON.T1CKPS1 = 0b0;
  T1CON.T1CKPS0 = 0b1;
  
  // Do not synchronize the external clock input
  T1CON.T1SYNC = 0b1;

  // Enable the 16-bit mode
  T1CON.T1RD16 = 0b1;

  T1GCON.TMR1GE = 0b0;   // Disable the gate enable
  T1CON.TMR1ON  = 0b1;   // Turn on the timer
}

// ----------------------------------------------------------------------------------------------------
// Init interrupts
// ----------------------------------------------------------------------------------------------------
void rat_init_interrupts (void)
{
  // --------------------------------------------------------------------------------------------------
  // Generic interrupt settings
  // --------------------------------------------------------------------------------------------------

  // Disable the interrupt priority
  INTCON.IPEN = 0b0;

  // Enable the peripheral interrupts
  INTCON.PEIE = 0b1;

  // --------------------------------------------------------------------------------------------------
  // Timer 1
  // --------------------------------------------------------------------------------------------------

  // Enable Timer 1 interrupt
  PIE1.TMR1IE = 0b1;

  // Clear the interrupt flag of timer 1
  PIR1.TMR1IF = 0b0;

  // --------------------------------------------------------------------------------------------------
  // Global interrupt settings
  // --------------------------------------------------------------------------------------------------
  
  // Enable the global interrupts
  INTCON.GIE = 0b1;
}

// ----------------------------------------------------------------------------------------------------
// Init debugging
// ----------------------------------------------------------------------------------------------------
static void rat_init_debugging (void)
{
  // --------------------------------------------------------------------------------------------------
  // Auxiliary variables
  // --------------------------------------------------------------------------------------------------
  uint8_t software_uart_code;
}

// ----------------------------------------------------------------------------------------------------
// Init the MCU
// ----------------------------------------------------------------------------------------------------
void rat_mcu_init (void)
{
  // --------------------------------------------------------------------------------------------------
  // Init pins, clocks, peripherals, timers, and interrupts
  // --------------------------------------------------------------------------------------------------
  rat_init_pins();
  rat_init_clocks();

  rat_init_i2c();
  rat_init_spi();
  rat_init_uart();
  
  rat_init_timers();
  rat_init_interrupts();
  
  // --------------------------------------------------------------------------------------------------
  // Init debugging
  // --------------------------------------------------------------------------------------------------
  rat_init_debugging();
}

// ----------------------------------------------------------------------------------------------------
// Delay in milliseconds
// ----------------------------------------------------------------------------------------------------
void rat_delay (uint16_t limit)
{
  // Auxiliary variables
  uint32_t init_cycles;
  uint32_t curr_cycles;
  uint32_t diff_cycles;

  uint32_t milliseconds;

  // Set the init state
  init_cycles = TMR1H;
  init_cycles = init_cycles << 8;
  init_cycles += TMR1L;

  diff_cycles = 0;

  // Calculate the difference in milliseconds
  //
  // Note that the frequency is 32,768 KHz and the prescaler is 4:1
  while (true) {
    curr_cycles = TMR1H;
    curr_cycles = curr_cycles << 8;
    curr_cycles += TMR1L;

    if (curr_cycles < init_cycles) {
      diff_cycles += curr_cycles + 65535 - init_cycles;
    } else {
      diff_cycles += curr_cycles - init_cycles;
    }

    init_cycles = curr_cycles;

    milliseconds = ( diff_cycles * 1000 * 4 ) / 32768;

    if (milliseconds >= limit) {
      break;
    }
  }
}

// ----------------------------------------------------------------------------------------------------
// Reset
// ----------------------------------------------------------------------------------------------------
void rat_reset (void)
{
  asm RESET;
}

// ----------------------------------------------------------------------------------------------------
// Sleep
// ----------------------------------------------------------------------------------------------------
void rat_sleep (void)
{
  asm SLEEP;
}

// ----------------------------------------------------------------------------------------------------
// Clear watchdog
//
// Note! This is a very dangerous command, because the purpose of the watchdog is to make sure that
// the microcontroller can recover from unexpected situations! Do not use this command unless
// absolutely necessary!
// ----------------------------------------------------------------------------------------------------
void rat_clear_watchdog (void)
{
  asm CLRWDT;
}